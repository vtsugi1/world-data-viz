<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dynamic Bubble Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .controls {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <label for="countries">Select Countries:</label>
        <select id="countries" multiple></select>
        <br>
        <label for="startYear">Start Year:</label>
        <select id="startYear"></select>
        <label for="endYear">End Year:</label>
        <select id="endYear"></select>
        <br>
        <button id="playButton">Play</button>
        <button id="stopButton">Stop</button>
    </div>
    <div style="width: 75%; margin: auto;">
        <canvas id="bubbleChart"></canvas>
    </div>

    <script>
        let stopAnimation = false;
        let chart = null;

        async function fetchData(url) {
            const response = await fetch(url);
            return await response.json();
        }

        function populateSelect(selectElement, items) {
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.text = item;
                selectElement.add(option);
            });
        }

        async function initializeControls() {
            const countries = await fetchData('/countries');
            const years = await fetchData('/years');

            populateSelect(document.getElementById('countries'), countries);
            populateSelect(document.getElementById('startYear'), years);
            populateSelect(document.getElementById('endYear'), years);
        }

        function formatData(data, selectedCountries, year) {
            return data.filter(d => selectedCountries.includes(d.Country) && d.Year === year)
                .map(d => ({
                    x: d.Population,
                    y: d.Military_Expenditure,
                    r: d.GDP / 1e12, // Scale GDP for bubble size
                    label: d.Country,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)'
                }));
        }

        function createBubbleChart(data, selectedCountries, year) {
            const ctx = document.getElementById('bubbleChart').getContext('2d');
            return new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Countries',
                        data: data
                    }]
                },
                options: {
                    animation: {
                        duration: 2000
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Population'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Military Expenditure (% of GDP)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Countries: ${selectedCountries.join(', ')} | Year: ${year}`
                        },
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        function updateChart(chart, data, selectedCountries, year) {
            chart.data.datasets[0].data = data;
            chart.options.plugins.title.text = `Countries: ${selectedCountries.join(', ')} | Year: ${year}`;
            chart.update();
        }

        async function playAnimation(chart, data, selectedCountries, startYear, endYear) {
            stopAnimation = false;
            for (let year = startYear; year <= endYear; year++) {
                if (stopAnimation) {
                    break;
                }
                const filteredData = formatData(data, selectedCountries, year);
                updateChart(chart, filteredData, selectedCountries, year);
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay between frames
            }
        }

        document.getElementById('playButton').addEventListener('click', async () => {
            const selectedCountries = Array.from(document.getElementById('countries').selectedOptions).map(option => option.value);
            const startYear = parseInt(document.getElementById('startYear').value);
            const endYear = parseInt(document.getElementById('endYear').value);
            const data = await fetchData('/data');

            // If a chart already exists, destroy it before creating a new one
            if (chart) {
                chart.destroy();
            }

            // Create a new chart instance
            const formattedData = formatData(data, selectedCountries, startYear);
            chart = createBubbleChart(formattedData, selectedCountries, startYear);

            // Start the animation
            playAnimation(chart, data, selectedCountries, startYear, endYear);
        });

        document.getElementById('stopButton').addEventListener('click', () => {
            stopAnimation = true;
        });

        initializeControls();
    </script>
</body>
</html>
